*** Begin Patch
*** Update File: c:\Users\Eduardo\OneDrive\Documentos\TrabalhoAlexP2\ProjetoAlexEscola\ExcluirAlunos.php
@@
-<?php
-// Verifica se o ID foi passado via GET
-if (isset($_GET['id_aluno'])) {
-    $id_aluno = $_GET['id_aluno'];
-
-    // Conecta ao banco
-    $conn = new mysqli("localhost", "root", "", "escola");
-
-    if ($conn->connect_error) {
-        die("Erro de conexão: " . $conn->connect_error);
-    }
-
-    // Prepara a exclusão
-    $stmt = $conn->prepare("DELETE FROM alunos WHERE id_aluno = ?");
-    $stmt->bind_param("i", $id_aluno);
-
-    if ($stmt->execute()) {
-        echo "Aluno excluído com sucesso!<br>";
-        echo "<a href='listarAlunos.php'>Voltar para Lista de Alunos</a><br>";
-        echo "<a href='index.html'>Voltar ao Menu Principal</a>";
-    } else {
-        echo "Erro ao excluir aluno: " . $stmt->error;
-    }
-
-    $stmt->close();
-    $conn->close();
-} else {
-    echo "ID do aluno não especificado.";
-}
-?>
+<?php
+// Verifica se o ID foi passado via GET
+if (isset($_GET['id_aluno'])) {
+    $id_aluno = (int) $_GET['id_aluno'];
+
+    // Conecta ao banco
+    $conn = new mysqli("localhost", "root", "", "escola");
+
+    if ($conn->connect_error) {
+        die("Erro de conexão: " . $conn->connect_error);
+    }
+
+    // Use transaction to ensure integrity: delete dependent rows first
+    $conn->begin_transaction();
+    try {
+        // Remove associações na tabela alunos_materias
+        $stmt = $conn->prepare("DELETE FROM alunos_materias WHERE id_aluno = ?");
+        if ($stmt === false) {
+            throw new Exception('Falha ao preparar exclusão em alunos_materias: ' . $conn->error);
+        }
+        $stmt->bind_param("i", $id_aluno);
+        if (!$stmt->execute()) {
+            throw new Exception('Erro ao excluir em alunos_materias: ' . $stmt->error);
+        }
+        $stmt->close();
+
+        // Agora exclui o aluno
+        $stmt = $conn->prepare("DELETE FROM alunos WHERE id_aluno = ?");
+        if ($stmt === false) {
+            throw new Exception('Falha ao preparar exclusão em alunos: ' . $conn->error);
+        }
+        $stmt->bind_param("i", $id_aluno);
+        if (!$stmt->execute()) {
+            throw new Exception('Erro ao excluir aluno: ' . $stmt->error);
+        }
+        $stmt->close();
+
+        $conn->commit();
+
+        echo "Aluno excluído com sucesso!<br>";
+        echo "<a href='listarAlunos.php'>Voltar para Lista de Alunos</a><br>";
+        echo "<a href='index.html'>Voltar ao Menu Principal</a>";
+    } catch (Exception $e) {
+        $conn->rollback();
+        echo "Erro ao excluir aluno (transação revertida): " . $e->getMessage();
+    }
+
+    $conn->close();
+} else {
+    echo "ID do aluno não especificado.";
+}
+?>
*** End Patch
