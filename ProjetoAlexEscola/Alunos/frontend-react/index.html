<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Listar Alunos - React</title>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        padding: 30px;
      }

      h1 {
        color: #333;
        margin-bottom: 30px;
        text-align: center;
        font-size: 2.5em;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s;
        margin: 5px;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5568d3;
        transform: translateY(-2px);
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn-success:hover {
        background: #218838;
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      .btn-danger:hover {
        background: #c82333;
      }

      .btn-warning {
        background: #ffc107;
        color: #333;
      }

      .btn-warning:hover {
        background: #e0a800;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      th {
        background: #667eea;
        color: white;
        font-weight: 600;
      }

      tr:hover {
        background: #f8f9fa;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }

      .modal.show {
        display: flex;
      }

      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        color: #333;
        font-weight: 600;
      }

      input,
      select {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #667eea;
      }

      .alert {
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #667eea;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // Detectar caminho base automaticamente
      const basePath = window.location.pathname.substring(
        0,
        window.location.pathname.lastIndexOf("/frontend-react")
      );
      const API_BASE = basePath + "/api_alunos.php";
      const API_CURSOS =
        basePath.replace("/Alunos", "/Cursos") + "/api_cursos.php";

      function App() {
        const [alunos, setAlunos] = useState([]);
        const [cursos, setCursos] = useState([]);
        const [loading, setLoading] = useState(true);
        const [showModal, setShowModal] = useState(false);
        const [editingAluno, setEditingAluno] = useState(null);
        const [message, setMessage] = useState(null);

        useEffect(() => {
          loadAlunos();
          loadCursos();
        }, []);

        const loadAlunos = async () => {
          try {
            const response = await fetch(API_BASE);
            const data = await response.json();
            setAlunos(data);
            setLoading(false);
          } catch (error) {
            showMessage("Erro ao carregar alunos: " + error.message, "error");
            setLoading(false);
          }
        };

        const loadCursos = async () => {
          try {
            const response = await fetch(API_CURSOS);
            const data = await response.json();
            setCursos(data);
          } catch (error) {
            console.error("Erro ao carregar cursos:", error);
          }
        };

        const showMessage = (msg, type = "success") => {
          setMessage({ text: msg, type });
          setTimeout(() => setMessage(null), 3000);
        };

        const handleDelete = async (id) => {
          if (!confirm("Tem certeza que deseja excluir este aluno?")) return;

          try {
            const response = await fetch(API_BASE, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id_aluno: id }),
            });

            if (response.ok) {
              showMessage("Aluno excluído com sucesso!");
              loadAlunos();
            } else {
              showMessage("Erro ao excluir aluno", "error");
            }
          } catch (error) {
            showMessage("Erro ao excluir aluno: " + error.message, "error");
          }
        };

        const handleEdit = (aluno) => {
          setEditingAluno(aluno);
          setShowModal(true);
        };

        const handleNew = () => {
          setEditingAluno(null);
          setShowModal(true);
        };

        const handleSubmit = async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const data = {
            nome: formData.get("nome"),
            data_nascimento: formData.get("data_nascimento"),
            email: formData.get("email"),
            telefone: formData.get("telefone"),
            id_curso: parseInt(formData.get("id_curso")),
          };

          if (editingAluno) {
            data.id_aluno = editingAluno.id_aluno;
          }

          try {
            const response = await fetch(API_BASE, {
              method: editingAluno ? "PUT" : "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });

            if (response.ok) {
              showMessage(
                editingAluno
                  ? "Aluno atualizado com sucesso!"
                  : "Aluno cadastrado com sucesso!"
              );
              setShowModal(false);
              loadAlunos();
            } else {
              showMessage("Erro ao salvar aluno", "error");
            }
          } catch (error) {
            showMessage("Erro ao salvar aluno: " + error.message, "error");
          }
        };

        return (
          <div className="container">
            <h1>Listar Alunos - React</h1>

            <div style={{ marginBottom: "15px" }}>
              <a
                href="../../index.html"
                className="btn"
                style={{
                  background: "#6c757d",
                  textDecoration: "none",
                  display: "inline-block",
                }}
              >
                Voltar ao Menu Principal
              </a>
            </div>

            {message && (
              <div className={`alert alert-${message.type}`}>
                {message.text}
              </div>
            )}

            <button className="btn btn-primary" onClick={handleNew}>
               Novo Aluno
            </button>

            {loading ? (
              <div className="loading">Carregando...</div>
            ) : (
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Data Nasc.</th>
                    <th>Email</th>
                    <th>Telefone</th>
                    <th>Curso</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody>
                  {alunos.map((aluno) => (
                    <tr key={aluno.id_aluno}>
                      <td>{aluno.id_aluno}</td>
                      <td>{aluno.nome}</td>
                      <td>{aluno.data_nascimento}</td>
                      <td>{aluno.email}</td>
                      <td>{aluno.telefone}</td>
                      <td>{aluno.curso_nome || "—"}</td>
                      <td>
                        <button
                          className="btn btn-warning"
                          onClick={() => handleEdit(aluno)}
                        >
                          Editar
                        </button>
                        <button
                          className="btn btn-danger"
                          onClick={() => handleDelete(aluno.id_aluno)}
                        >
                          Excluir
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}

            {showModal && (
              <AlunoModal
                aluno={editingAluno}
                cursos={cursos}
                onClose={() => setShowModal(false)}
                onSubmit={handleSubmit}
              />
            )}
          </div>
        );
      }

      function AlunoModal({ aluno, cursos, onClose, onSubmit }) {
        return (
          <div className="modal show" onClick={onClose}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
              <h2>{aluno ? "Editar Aluno" : "Novo Aluno"}</h2>
              <form onSubmit={onSubmit}>
                <div className="form-group">
                  <label>Nome:</label>
                  <input
                    type="text"
                    name="nome"
                    defaultValue={aluno?.nome || ""}
                    required
                  />
                </div>
                <div className="form-group">
                  <label>Data de Nascimento:</label>
                  <input
                    type="date"
                    name="data_nascimento"
                    defaultValue={aluno?.data_nascimento || ""}
                    required
                  />
                </div>
                <div className="form-group">
                  <label>Email:</label>
                  <input
                    type="email"
                    name="email"
                    defaultValue={aluno?.email || ""}
                    required
                  />
                </div>
                <div className="form-group">
                  <label>Telefone:</label>
                  <input
                    type="text"
                    name="telefone"
                    defaultValue={aluno?.telefone || ""}
                    maxLength="11"
                    required
                  />
                </div>
                <div className="form-group">
                  <label>Curso:</label>
                  <select
                    name="id_curso"
                    defaultValue={aluno?.id_curso || ""}
                    required
                  >
                    <option value="">Selecione um curso</option>
                    {cursos.map((curso) => (
                      <option key={curso.id_curso} value={curso.id_curso}>
                        {curso.nome}
                      </option>
                    ))}
                  </select>
                </div>
                <div
                  style={{
                    display: "flex",
                    gap: "10px",
                    justifyContent: "flex-end",
                  }}
                >
                  <button
                    type="button"
                    className="btn btn-danger"
                    onClick={onClose}
                  >
                    Cancelar
                  </button>
                  <button type="submit" className="btn btn-success">
                    Salvar
                  </button>
                </div>
              </form>
            </div>
          </div>
        );
      }

      ReactDOM.render(<App />, document.getElementById("root"));
    </script>
  </body>
</html>
